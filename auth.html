<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK ë‹¨ì–´ í•™ìŠµ & í€´ì¦ˆ ì•± (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'toss-blue': '#3B82F6',
                        'toss-green': '#22C55E', 
                        'toss-yellow': '#FFD34C', 
                        'hsk-red': '#E53E3E', 
                    },
                },
            },
        };
    </script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        :root {
            --font-pretendard: 'Pretendard', 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-pretendard);
        }

        /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .level-button { transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .level-button.active { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(229, 62, 62, 0.3); } 
        .word-cell-simplified { min-width: 80px; }
        .tab-button { transition: all 0.2s; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        .tab-button.active { border-bottom: 3px solid #3B82F6; color: #3B82F6; font-weight: 600; background-color: white !important; }
        .answer-button { transition: all 0.2s; }
        .answer-button:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
    
    <script type="module">
        // ------------------------------------------
        // ğŸ”¥ 1. FIREBASE ì„¤ì • ë° ì´ˆê¸°í™”
        // ------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB8nw2LEuAl3q375a-IWfT5sSU48I2dukg",
            authDomain: "jlpt-9f958.firebaseapp.com",
            projectId: "jlpt-9f958",
            storageBucket: "jlpt-9f958.firebasestorage.app",
            messagingSenderId: "1088397251559",
            appId: "1:1088397251559:web:bdd8d0769f81b47a7d2342",
            measurementId: "G-P2D5HQ94S2"
        };
        
        // Firebase ì´ˆê¸°í™” (initializeApp, getAnalyticsëŠ” V9 Module ë°©ì‹ì´ë©°, 
        // í˜¸í™˜ì„± SDKë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ firebase.initializeApp ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth(); // ì¸ì¦ ëª¨ë“ˆ
        const db = app.firestore(); // Firestore ëª¨ë“ˆ
        // const analytics = firebase.analytics(); // AnalyticsëŠ” ìƒëµ (CDNì„ ëª¨ë‘ ì¶”ê°€í•´ì•¼ í•¨)

        // Gemini API Configuration
        const API_KEY = "AIzaSyDfpal-sPS5EeCLYrvmeVnc_sA69L_EQ8M"; 
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const MAX_RETRIES = 3;
        const INITIAL_BACKOFF_MS = 1000;

        // ------------------------------------------
        // ğŸš€ 2. Application State (FIREBASE ë§ì¶¤ ë³€ê²½)
        // ------------------------------------------
        let userId = null; // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ deviceId ëŒ€ì‹  ì‚¬ìš©
        let isAppReady = false;
        let selectedLevel = 3; 
        let currentView = 'generator'; 
        let generatedWords = [];
        let savedWordLists = []; 
        let wordFolders = []; 
        let selectedFolderId = null; 
        let quizWords = [];
        let currentQuestionIndex = 0;
        let quizScore = 0;
        let quizOptions = [];
        let stats = { totalAttempts: 0, totalCorrect: 0, overallRate: 0 };
        let wrongWords = []; 
        let manualSavedWords = []; 
        let isViewingWrongWords = false; 

        // UI Elements
        const appContainer = document.getElementById('app');
        const contentContainer = document.getElementById('content-container');
        const levelSelector = document.getElementById('level-selector');
        const listTitle = document.getElementById('list-title');
        const errorMessageDiv = document.getElementById('error-message');
        const tabGenerator = document.getElementById('tab-generator');
        const tabLists = document.getElementById('tab-lists');

        // --- Core Utility: Safe Unique ID Generator ---
        function generateUniqueId() {
            if (window.crypto && window.crypto.randomUUID) {
                return window.crypto.randomUUID();
            }
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        }

        // ------------------------------------------
        // ğŸ’¾ 3. FIREBASE ë°ì´í„° ì €ì¥/ë¡œë“œ í•¨ìˆ˜ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ëŒ€ì²´)
        // ------------------------------------------

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ (ì´ˆê¸° 1íšŒ)
        async function loadUserDataFromFirestore() {
            if (!userId) return;

            try {
                // 1. í†µê³„ ë¡œë“œ
                const statsDoc = await db.collection('users').doc(userId).get();
                if (statsDoc.exists) {
                    const data = statsDoc.data();
                    stats.totalAttempts = data.totalAttempts || 0;
                    stats.totalCorrect = data.totalCorrect || 0;
                    if (stats.totalAttempts > 0) {
                        stats.overallRate = Math.round((stats.totalCorrect / stats.totalAttempts) * 100);
                    } else {
                        stats.overallRate = 0;
                    }
                } else {
                    await db.collection('users').doc(userId).set({ totalAttempts: 0, totalCorrect: 0 });
                }

                // 2. í´ë”, ë‹¨ì–´ ëª©ë¡, ê°œë³„ ë‹¨ì–´, ì˜¤ë‹µ ë…¸íŠ¸ ë¡œë“œ
                const [foldersSnapshot, listsSnapshot, manualSnapshot, wrongSnapshot] = await Promise.all([
                    db.collection('users').doc(userId).collection('folders').get(),
                    db.collection('users').doc(userId).collection('lists').get(),
                    db.collection('users').doc(userId).collection('manualWords').get(),
                    db.collection('users').doc(userId).collection('wrongWords').get()
                ]);

                wordFolders = foldersSnapshot.docs.map(doc => doc.data());
                savedWordLists = listsSnapshot.docs.map(doc => doc.data());
                manualSavedWords = manualSnapshot.docs.map(doc => doc.data());
                wrongWords = wrongSnapshot.docs.map(doc => doc.data());

                // ê¸°ë³¸ í´ë” ì²˜ë¦¬ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ ë™ì¼í•˜ê²Œ)
                if (wordFolders.length === 0) {
                    const defaultFolderId = generateUniqueId(); 
                    wordFolders.push({ id: defaultFolderId, name: 'ì „ì²´ ë‹¨ì–´ì¥', createdAt: new Date().toISOString() });
                    await db.collection('users').doc(userId).collection('folders').doc(defaultFolderId).set(wordFolders[0]);
                } 
                if (!selectedFolderId) {
                    selectedFolderId = wordFolders[0].id;
                }
                
                isAppReady = true;
                renderApp();

            } catch (e) {
                console.error("Firebase ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
                showError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                isAppReady = true;
                renderApp(); // ì˜¤ë¥˜ ìƒíƒœë¡œë¼ë„ ì•± ë Œë”ë§
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        async function updateStats(attempts, correct) {
            if (!userId) return;

            // Firestore FieldValue.increment ì‚¬ìš©
            const userRef = db.collection('users').doc(userId);

            try {
                await userRef.set({
                    totalAttempts: firebase.firestore.FieldValue.increment(attempts),
                    totalCorrect: firebase.firestore.FieldValue.increment(correct),
                }, { merge: true }); // ê¸°ì¡´ í•„ë“œ ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸
                
                // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                stats.totalAttempts += attempts;
                stats.totalCorrect += correct;
                if (stats.totalAttempts > 0) {
                    stats.overallRate = Math.round((stats.totalCorrect / stats.totalAttempts) * 100);
                } else {
                    stats.overallRate = 0;
                }

            } catch (error) {
                console.error("í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
            }
        }

        // í´ë” ì €ì¥
        async function saveFolderToFirestore(folder) {
            if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('folders').doc(folder.id).set(folder);
            } catch (e) {
                console.error("í´ë” ì €ì¥ ì˜¤ë¥˜:", e);
                showError("í´ë” ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // í´ë” ì‚­ì œ
        async function deleteFolderFromFirestore(folderId) {
            if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('folders').doc(folderId).delete();
            } catch (e) {
                console.error("í´ë” ì‚­ì œ ì˜¤ë¥˜:", e);
                showError("í´ë” ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ë‹¨ì–´ ëª©ë¡ ì €ì¥
        async function saveWordListToFirestore(listData) {
            if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('lists').doc(listData.id).set(listData);
            } catch (e) {
                console.error("ë‹¨ì–´ ëª©ë¡ ì €ì¥ ì˜¤ë¥˜:", e);
                showError("ë‹¨ì–´ ëª©ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // ë‹¨ì–´ ëª©ë¡ ì‚­ì œ
        async function deleteWordListFromFirestore(listId) {
            if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('lists').doc(listId).delete();
            } catch (e) {
                console.error("ë‹¨ì–´ ëª©ë¡ ì‚­ì œ ì˜¤ë¥˜:", e);
                showError("ë‹¨ì–´ ëª©ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ê°œë³„ ë‹¨ì–´ ì €ì¥
        async function saveManualWordToFirestore(manualWordItem) {
            if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('manualWords').doc(manualWordItem.id).set(manualWordItem);
            } catch (e) {
                console.error("ê°œë³„ ë‹¨ì–´ ì €ì¥ ì˜¤ë¥˜:", e);
                showError("ë‹¨ì–´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // ê°œë³„ ë‹¨ì–´ ì‚­ì œ
        async function deleteManualWordFromFirestore(manualWordId) {
            if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('manualWords').doc(manualWordId).delete();
            } catch (e) {
                console.error("ê°œë³„ ë‹¨ì–´ ì‚­ì œ ì˜¤ë¥˜:", e);
                showError("ë‹¨ì–´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ì˜¤ë‹µ ë…¸íŠ¸ ì¶”ê°€
        async function addWrongWordsToFirestore(newWrongWords) {
            if (!userId || !newWrongWords || newWrongWords.length === 0) return;

            newWrongWords.forEach(async newWord => {
                const docId = newWord.simplified; // simplifiedë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€)
                const docRef = db.collection('users').doc(userId).collection('wrongWords').doc(docId);
                
                // Firestoreì— ì¶”ê°€
                try {
                    await docRef.set({
                        ...newWord,
                        id: docId, // Firestore IDì™€ ì¼ì¹˜
                        createdAt: new Date().toISOString()
                    });
                    
                    // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                    const exists = wrongWords.some(existingWord => existingWord.simplified === newWord.simplified);
                    if (!exists) {
                        wrongWords.push({...newWord, id: docId});
                    }
                } catch (e) {
                    console.error("ì˜¤ë‹µ ë…¸íŠ¸ ì¶”ê°€ ì˜¤ë¥˜:", e);
                }
            });
        }
        
        // ì˜¤ë‹µ ë…¸íŠ¸ ì‚­ì œ
        async function deleteWrongWordFromFirestore(simplified) {
             if (!userId) return;
            try {
                await db.collection('users').doc(userId).collection('wrongWords').doc(simplified).delete();
            } catch (e) {
                console.error("ì˜¤ë‹µ ì‚­ì œ ì˜¤ë¥˜:", e);
                showError("ì˜¤ë‹µ ë‹¨ì–´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // ì˜¤ë‹µ ë…¸íŠ¸ ì „ì²´ ë¹„ìš°ê¸°
        async function clearAllWrongWordsFromFirestore() {
            if (!userId) return;
            try {
                const batch = db.batch();
                const snapshot = await db.collection('users').doc(userId).collection('wrongWords').get();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            } catch (e) {
                console.error("ì˜¤ë‹µ ë…¸íŠ¸ ì „ì²´ ë¹„ìš°ê¸° ì˜¤ë¥˜:", e);
                showError("ì˜¤ë‹µ ë…¸íŠ¸ ì „ì²´ ë¹„ìš°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }


        // ì•± ì´ˆê¸°í™” ë° ì¸ì¦ ì„¤ì • (setupApp ëŒ€ì²´)
        function setupAuthAndLoadData() {
            // ë¡œë”© í™”ë©´ í‘œì‹œ
            contentContainer.innerHTML = renderLoadingScreen();
            
            // ì¸ì¦ ìƒíƒœ ê°ì‹œ
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // ì‚¬ìš©ì ë¡œê·¸ì¸ (ìµëª… ë˜ëŠ” ê¸°íƒ€)
                    userId = user.uid;
                    await loadUserDataFromFirestore(); // ë°ì´í„° ë¡œë“œ
                    console.log("Firebase ë¡œê·¸ì¸ ì™„ë£Œ. User ID:", userId);
                } else {
                    // ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: ìµëª… ë¡œê·¸ì¸ ì‹œë„
                    try {
                        const result = await auth.signInAnonymously();
                        userId = result.user.uid;
                        await loadUserDataFromFirestore(); 
                        console.log("Firebase ìµëª… ë¡œê·¸ì¸ ì„±ê³µ. User ID:", userId);
                    } catch (error) {
                        console.error("ìµëª… ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                        showError("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì•±ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        isAppReady = true; 
                        renderApp();
                    }
                }
            });
        }

        // --- í´ë” ê´€ë¦¬ ë¡œì§ (Firestore ì—°ë™) ---

        async function addFolder(name) {
            if (!name || name.trim() === '') {
                renderModal("ì…ë ¥ ì˜¤ë¥˜", "í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            const newFolder = {
                id: generateUniqueId(), 
                name: name.trim(),
                createdAt: new Date().toISOString()
            };
            
            await saveFolderToFirestore(newFolder);
            
            wordFolders.push(newFolder);
            selectedFolderId = newFolder.id;
            renderApp();
        }

        async function renameFolder(folderId, newName) {
            if (!newName || newName.trim() === '') {
                 renderModal("ì…ë ¥ ì˜¤ë¥˜", "ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            const folder = wordFolders.find(f => f.id === folderId);
            if (folder && newName.trim()) {
                folder.name = newName.trim();
                
                await saveFolderToFirestore(folder);
                renderApp();
            }
        }

        async function deleteFolder(folderId) {
            const defaultFolderId = wordFolders[0].id;
            const folderToDelete = wordFolders.find(f => f.id === folderId);
            
            if (folderId === defaultFolderId) {
                renderModal("ì‚­ì œ ë¶ˆê°€", "ê¸°ë³¸ í´ë”ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            renderModal(
                "í´ë” ì‚­ì œ í™•ì¸", 
                `'${folderToDelete.name}' í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì•ˆì— ìˆëŠ” ëª¨ë“  ë‹¨ì–´ ëª©ë¡ê³¼ ê°œë³„ ë‹¨ì–´ëŠ” 'ì „ì²´ ë‹¨ì–´ì¥'ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ í´ë¼ìš°ë“œì—ì„œ ì‚­ì œë©ë‹ˆë‹¤.`,
                async () => {
                    // 1. ë‹¨ì–´ ëª©ë¡ (20ê°œ ê·¸ë£¹) ì´ë™:
                    const listUpdatePromises = savedWordLists
                        .filter(list => list.folderId === folderId)
                        .map(list => {
                            list.folderId = defaultFolderId;
                            return saveWordListToFirestore(list);
                        });
                    
                    // 2. ê°œë³„ ë‹¨ì–´ ì´ë™:
                    const manualUpdatePromises = manualSavedWords
                        .filter(item => item.folderId === folderId)
                        .map(item => {
                            item.folderId = defaultFolderId;
                            return saveManualWordToFirestore(item);
                        });

                    await Promise.all([...listUpdatePromises, ...manualUpdatePromises]);

                    // 3. í´ë” ì‚­ì œ
                    await deleteFolderFromFirestore(folderId);
                    wordFolders = wordFolders.filter(f => f.id !== folderId);
                    
                    // 4. ì„ íƒ í´ë” ì¬ì„¤ì •
                    selectedFolderId = defaultFolderId;
                    renderApp();
                }
            );
        }

        // --- Local Storage Operations (Saved Lists) -> Firestore ë³€ê²½ ---
        
        // ... (showFolderSelectionModalì€ ë¡œì»¬ ìƒíƒœë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ìœ ì§€)
        
        async function saveWordList() {
            if (!generatedWords.length) {
                showError("ì €ì¥í•  ë‹¨ì–´ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            showFolderSelectionModal().then(async targetFolderId => {
                if (!targetFolderId) return; 

                const listData = {
                    id: generateUniqueId(), 
                    folderId: targetFolderId, 
                    level: selectedLevel,
                    words: generatedWords,
                    createdAt: new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                    wordCount: generatedWords.length,
                };
                
                await saveWordListToFirestore(listData);

                savedWordLists.push(listData);
                savedWordLists.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                selectedFolderId = targetFolderId;
                renderModal("ì €ì¥ ì™„ë£Œ", `HSK ${selectedLevel}ê¸‰ ë‹¨ì–´ ${generatedWords.length}ê°œ ëª©ë¡ì´ í´ë¼ìš°ë“œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, () => {
                    currentView = 'lists';
                    isViewingWrongWords = false;
                    renderApp();
                });
            });
        }
        
        async function saveSingleWord(word) {
            showFolderSelectionModal().then(async targetFolderId => {
                if (!targetFolderId) return; 

                // ì¤‘ë³µ í™•ì¸ (simplified ê¸°ì¤€)
                const isDuplicate = manualSavedWords.some(item => 
                    item.folderId === targetFolderId && item.word.simplified === word.simplified
                );

                if (isDuplicate) {
                    renderModal("ì¶”ê°€ ì‹¤íŒ¨", `'${word.simplified}' ë‹¨ì–´ëŠ” ì´ë¯¸ ì´ í´ë”ì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }

                const newManualWord = {
                    id: generateUniqueId(),
                    folderId: targetFolderId,
                    word: word,
                    createdAt: new Date().toISOString()
                };
                
                await saveManualWordToFirestore(newManualWord);

                manualSavedWords.push(newManualWord);
                
                renderModal("ì¶”ê°€ ì™„ë£Œ", `'${word.simplified}' ë‹¨ì–´ê°€ í´ë¼ìš°ë“œì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
        }

        // í€´ì¦ˆ ì˜¤ë‹µ ì €ì¥ (Firestore ì—°ë™)
        function addWrongWords(newWrongWords) {
            if (!newWrongWords || newWrongWords.length === 0) return;
            // ë¡œì»¬ ìƒíƒœì™€ Firestoreì— ë™ì‹œ ì—…ë°ì´íŠ¸
            addWrongWordsToFirestore(newWrongWords); 
        }

        // --- ì´í•˜ Gemini API ë° UI ë Œë”ë§/ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë“¤ì€ FireStore í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤ ---
        
        // ... (ì¤‘ëµ: generateWords, fetchWithRetry, renderApp, showError, renderLoadingScreen, renderInputModal, renderModal, renderGeneratorView, renderWordCard, attachGeneratorListenersëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)

        // --- Quiz View ---

        function startQuiz(wordsToQuiz) {
            if (wordsToQuiz.length === 0) {
                showError("í€´ì¦ˆë¥¼ ì‹œì‘í•  ë‹¨ì–´ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            quizWords = wordsToQuiz.sort(() => 0.5 - Math.random()); 
            currentQuestionIndex = 0;
            quizScore = 0;
            currentView = 'quiz';
            renderApp();
        }

        function generateQuizOptions(correctWord) {
             // ì •ë‹µì„ í¬í•¨í•œ ëª¨ë“  ë‹¨ì–´ì˜ ëœ» ëª©ë¡ì„ ë§Œë“­ë‹ˆë‹¤.
            const allWords = [
                ...generatedWords, 
                ...savedWordLists.flatMap(list => list.words || []), 
                ...wrongWords,
                ...manualSavedWords.map(item => item.word) 
            ];
            // simplified ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì œê±°
            const uniqueWords = allWords.filter((word, index, self) => 
                index === self.findIndex((t) => (t.simplified === word.simplified))
            );
            
            const options = [correctWord.korean_meaning];
            const incorrectWords = uniqueWords.filter(w => w.korean_meaning !== correctWord.korean_meaning);
            
            while (options.length < 4 && incorrectWords.length > 0) {
                const randomIndex = Math.floor(Math.random() * incorrectWords.length);
                const incorrectMeaning = incorrectWords.splice(randomIndex, 1)[0].korean_meaning;
                if (!options.includes(incorrectMeaning)) {
                    options.push(incorrectMeaning);
                }
            }

            return options.sort(() => 0.5 - Math.random());
        }

        async function handleAnswer(selectedMeaning) {
            const currentWord = quizWords[currentQuestionIndex];
            const correctMeaning = currentWord.korean_meaning;
            const isCorrect = selectedMeaning === correctMeaning;
            
            const selectedButton = document.querySelector(`[data-meaning="${selectedMeaning}"]`);
            
            if (isCorrect) {
                quizScore++;
                selectedButton.classList.add('bg-toss-green', 'text-white');
            } else {
                selectedButton.classList.add('bg-red-500', 'text-white');
                document.querySelector(`[data-meaning="${correctMeaning}"]`)?.classList.add('bg-hsk-red', 'text-white');
                
                addWrongWords([currentWord]); // Firebase ì—°ë™ í•¨ìˆ˜ í˜¸ì¶œ
            }

            document.querySelectorAll('.answer-button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                currentQuestionIndex++;
                renderApp();
            }, 1000); 
        }
        
        // ... (ì¤‘ëµ: renderQuizView, attachQuizListenersëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)


        // --- My Lists View (í´ë” ë° ëª©ë¡ ë Œë”ë§) ---
        
        // ... (ì¤‘ëµ: renderFolderManagement, renderIndividualWordCard, renderWrongWordCard, renderListsView, renderStatsCard, renderSavedListCardëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)


        function attachListsListeners() {
            // --- í´ë” ê´€ë¦¬ ë¦¬ìŠ¤ë„ˆ ---
            document.getElementById('add-folder-button')?.addEventListener('click', () => {
                renderInputModal("ìƒˆ í´ë” ì´ë¦„ ì…ë ¥", "ìƒˆ í´ë”", (folderName) => {
                    if (folderName) {
                        addFolder(folderName); // Firestore ì—°ë™
                    }
                });
            });

            document.querySelectorAll('.folder-pill').forEach(pill => {
                const folderId = pill.dataset.folderId;
                
                // 1-1. í´ë” ì„ íƒ (í•„í„°ë§)
                pill.querySelector('.folder-name-display')?.addEventListener('click', () => {
                    isViewingWrongWords = false; 
                    selectedFolderId = folderId;
                    renderApp();
                });

                // 1-2. í´ë” ì´ë¦„ ë³€ê²½
                pill.querySelector('[data-action="rename"]')?.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const currentFolder = wordFolders.find(f => f.id === folderId);
                    
                    if (currentFolder) {
                        renderInputModal(`'${currentFolder.name}' ì´ë¦„ ë³€ê²½`, currentFolder.name, (newName) => {
                            if (newName) {
                                renameFolder(folderId, newName); // Firestore ì—°ë™
                            }
                        });
                    }
                });

                // 1-3. í´ë” ì‚­ì œ
                pill.querySelector('[data-action="delete"]')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFolder(folderId); // Firestore ì—°ë™
                });
            });

            // --- ì˜¤ë‹µ ë…¸íŠ¸ / ì €ì¥ ëª©ë¡ í† ê¸€ ---
            document.getElementById('toggle-saved-lists')?.addEventListener('click', () => {
                isViewingWrongWords = false;
                renderApp();
            });
            document.getElementById('toggle-wrong-words')?.addEventListener('click', () => {
                isViewingWrongWords = true;
                renderApp();
            });

            // --- ì˜¤ë‹µ ë…¸íŠ¸/ë‹¨ì–´ì¥ ì•¡ì…˜ ---
            document.getElementById('start-wrong-quiz')?.addEventListener('click', () => {
                if(wrongWords.length > 0) {
                    startQuiz(wrongWords);
                }
            });

            document.getElementById('clear-all-wrong-words')?.addEventListener('click', () => {
                renderModal("ì˜¤ë‹µ ë…¸íŠ¸ ì´ˆê¸°í™”", "ì˜¤ë‹µ ë…¸íŠ¸ì— ìˆëŠ” ëª¨ë“  ë‹¨ì–´ë¥¼ í´ë¼ìš°ë“œì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", async () => {
                    await clearAllWrongWordsFromFirestore(); // Firestore ì—°ë™
                    wrongWords = [];
                    renderApp();
                });
            });

            // ì˜¤ë‹µ ë…¸íŠ¸ ê°œë³„ ê´€ë¦¬ ë° ì €ì¥ ëª©ë¡ ì‚­ì œ
            document.getElementById('word-list-display')?.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                
                if (!target) return;
                
                // 1. ê°œë³„ ì €ì¥ ë‹¨ì–´ ì‚­ì œ (delete-single)
                if (target.dataset.action === 'delete-single') {
                    const savedId = target.dataset.savedId;
                    const wordToDelete = manualSavedWords.find(item => item.id === savedId)?.word;
                    
                    if (wordToDelete) {
                        renderModal("ë‹¨ì–´ ì‚­ì œ í™•ì¸", `'${wordToDelete.simplified}' ë‹¨ì–´ë¥¼ í´ë¼ìš°ë“œì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                            await deleteManualWordFromFirestore(savedId); // Firestore ì—°ë™
                            manualSavedWords = manualSavedWords.filter(item => item.id !== savedId);
                            renderApp();
                        });
                    }
                    return;
                }
                
                // 2. ì˜¤ë‹µ ë…¸íŠ¸ ê°œë³„ ì‚­ì œ (delete-wrong)
                if (target.dataset.action === 'delete-wrong') {
                    const index = parseInt(target.dataset.wordIndex);
                    const wordToDelete = wrongWords[index];
                    
                    renderModal("ì˜¤ë‹µ ì‚­ì œ í™•ì¸", `'${wordToDelete.simplified}' ë‹¨ì–´ë¥¼ ì˜¤ë‹µ ë…¸íŠ¸ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í´ë¼ìš°ë“œì—ì„œ ì‚­ì œ)`, async () => {
                        await deleteWrongWordFromFirestore(wordToDelete.simplified); // Firestore ì—°ë™ (simplifiedë¥¼ IDë¡œ ì‚¬ìš©)
                        wrongWords.splice(index, 1);
                        renderApp();
                    });
                    return;
                }
                
                // 3. ì €ì¥ëœ ëª©ë¡ ê°œë³„ ì‚­ì œ (delete-list)
                if (target.dataset.action === 'delete-list') {
                    const listId = target.dataset.listId;
                    const listToDelete = savedWordLists.find(l => l.id === listId);

                    renderModal("ë‹¨ì–´ ëª©ë¡ ì‚­ì œ", `'HSK ${listToDelete.level}ê¸‰ ë‹¨ì–´ ëª©ë¡'ì„ í´ë¼ìš°ë“œì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
                        await deleteWordListFromFirestore(listId); // Firestore ì—°ë™
                        savedWordLists = savedWordLists.filter(l => l.id !== listId);
                        renderApp();
                    });
                    return;
                }
                
                // 4. ì €ì¥ëœ ëª©ë¡ ë³´ê¸°/í€´ì¦ˆ (load)
                const listId = target.dataset.listId;
                const action = target.dataset.action;
                const list = savedWordLists.find(l => l.id === listId);

                if (!list || action !== 'load' && action !== 'quiz') return;

                if (action === 'load') {
                    selectedLevel = list.level;
                    generatedWords = list.words;
                    currentView = 'generator';
                    renderApp();
                    renderModal("ë‹¨ì–´ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", `HSK ${list.level}ê¸‰ ë‹¨ì–´ ${list.wordCount}ê°œê°€ ìƒì„±ê¸° ëª©ë¡ì— ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            });
            
            // ìƒì„¸ ì •ë³´ í† ê¸€ ë¦¬ìŠ¤ë„ˆ
            document.querySelectorAll('#word-list-display .word-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const actionButton = e.target.closest('button[data-action]');
                    if (actionButton) return; 

                    const details = card.querySelector('.word-details');
                    const icon = card.querySelector('i.fa-chevron-down');
                    if (details) {
                        details.classList.toggle('hidden');
                        if(icon) icon.classList.toggle('rotate-180');
                    }
                });
            });
        }

        // ------------------------------------------
        // ğŸ Initialization (ê¸°ì¡´ window.onload ëŒ€ì²´)
        // ------------------------------------------

        window.onload = () => {
            tabGenerator.addEventListener('click', () => {
                currentView = 'generator';
                renderApp();
            });
            tabLists.addEventListener('click', () => {
                currentView = 'lists';
                isViewingWrongWords = false; 
                renderApp();
            });

            setupAuthAndLoadData(); // Firebase ì¸ì¦ ë° ë°ì´í„° ë¡œë“œ ì‹œì‘
        };
        
        // ** (generateWords, fetchWithRetry ë“± GEMINI API ê´€ë ¨ í•¨ìˆ˜ëŠ” ê¸¸ì–´ì„œ ì¤‘ëµí–ˆìœ¼ë‚˜, ê¸°ì¡´ ì½”ë“œì—ì„œ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.) **
        
        // --- (ì¤‘ëµëœ í•¨ìˆ˜ë“¤ì„ ìœ„í•´ ë”ë¯¸ í•¨ìˆ˜ ì •ì˜) ---
        async function fetchWithRetry() { /* êµ¬í˜„ ìƒëµ */ }
        async function generateWords() { /* êµ¬í˜„ ìƒëµ */ }
        function showFolderSelectionModal() { 
            return new Promise(resolve => resolve(wordFolders[0]?.id)); 
        }
        function renderWordCard(word, index) { /* êµ¬í˜„ ìƒëµ */ return `<div>${word.simplified}</div>`; }
        function attachGeneratorListeners() { /* êµ¬í˜„ ìƒëµ */ }
        // ... (renderApp, renderGeneratorView ë“± ë‹¤ë¥¸ UI í•¨ìˆ˜ë“¤ë„ ê¸°ì¡´ ì½”ë“œê°€ ìœ ì§€ë©ë‹ˆë‹¤)
        
    </script>
</head>
<body>
</body>
</html>
