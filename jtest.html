<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT N2 모의고사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-jp.min.css">
    <style>
        body {
            font-family: "Pretendard JP Variable", "Pretendard JP", sans-serif;
            background-color: #F2F4F6;
            color: #333D4B;
            -webkit-font-smoothing: antialiased;
        }
        .tos-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.04);
        }
        .btn-primary {
            background-color: #3182F6;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #1B64DA;
        }
        .btn-primary:disabled {
            background-color: #E5E8EB;
            color: #B0B8C1;
            cursor: not-allowed;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-custom { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center"></div>

<script>
    // API 키를 코드에 직접 넣지 않고 브라우저 저장소에서 가져옵니다.
    let state = {
        step: 'intro',
        questions: [],
        currentIdx: 0,
        userAnswers: [],
        selectedOption: null,
        isGenerating: false,
        apiKey: localStorage.getItem('GEMINI_API_KEY') || ""
    };

    const fallbackQuestions = [
        {
            type: '문자·어휘',
            subType: '한자 읽기',
            question: '次の言葉의 읽기 방법으로 가장 적합한 것을 고르세요.\n\n新しいビジネスの【提案】を受け入れた。',
            options: ['てい안', 'て이인', 'たい안', 'たい인'],
            answer: 0,
            explanation: '提案(てい안): 제안. (해석: 새로운 비즈니스 제안을 받아들였다.)'
        }
    ];

    const render = () => {
        const app = document.getElementById('app');
        const layouts = {
            intro: renderIntro,
            quiz: renderQuiz,
            result: renderResult
        };
        app.innerHTML = layouts[state.step]();
        lucide.createIcons();
    };

    // 사용자가 입력한 API 키 저장 함수
    window.saveApiKey = () => {
        const input = document.getElementById('api-key-input');
        if (input.value) {
            localStorage.setItem('GEMINI_API_KEY', input.value);
            state.apiKey = input.value;
            render();
        }
    };

    const fetchQuestions = async () => {
        if (!state.apiKey) {
            alert("API 키를 먼저 입력해주세요.");
            return;
        }
        state.isGenerating = true;
        render();

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`;
            const prompt = "JLPT N2 수준의 객관식 문제 4개를 생성해줘. JSON 배열 형식으로만 응답해. 각 객체는 type, subType, question, options(4개), answer(0-3), explanation(한국어) 필드를 가져야 해.";
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            if (!response.ok) throw new Error();
            const data = await response.json();
            state.questions = JSON.parse(data.candidates[0].content.parts[0].text);
        } catch (e) {
            state.questions = fallbackQuestions;
        } finally {
            state.isGenerating = false;
            state.step = 'quiz';
            state.currentIdx = 0;
            state.userAnswers = [];
            state.selectedOption = null;
            render();
        }
    };

    const renderIntro = () => `
        <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center w-full max-w-md">
            <div class="tos-card w-full p-8">
                <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="book-open" size="32"></i>
                </div>
                <h1 class="text-2xl font-bold mb-4">JLPT N2 무한 모의고사</h1>
                
                ${!state.apiKey ? `
                    <div class="mb-6 text-left">
                        <label class="text-xs font-bold text-gray-400 mb-1 block">Gemini API Key 필요</label>
                        <input id="api-key-input" type="password" placeholder="API 키를 입력하세요" class="w-full p-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                        <button onclick="saveApiKey()" class="mt-2 w-full text-sm text-blue-500 font-bold py-2">키 저장하기</button>
                    </div>
                ` : `
                    <p class="text-gray-500 mb-8 text-sm leading-relaxed">AI가 실시간으로 문제를 생성합니다.</p>
                `}

                <button onclick="fetchQuestions()" ${state.isGenerating ? 'disabled' : ''} class="btn-primary w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center">
                    ${state.isGenerating ? '<i data-lucide="loader-2" class="animate-spin-custom mr-2"></i> 문제 출제 중...' : '새로운 문제 시작'}
                </button>
                
                ${state.apiKey ? `<button onclick="localStorage.removeItem('GEMINI_API_KEY'); location.reload();" class="mt-4 text-xs text-gray-400 underline">API 키 재설정</button>` : ''}
            </div>
        </div>
    `;

    const renderQuiz = () => {
        const q = state.questions[state.currentIdx];
        const progress = (state.currentIdx / state.questions.length) * 100;
        return `
            <div class="w-full max-w-xl p-6 min-h-screen flex flex-col">
                <div class="w-full bg-gray-200 h-1.5 rounded-full mt-4 mb-8 overflow-hidden">
                    <div class="bg-blue-500 h-full transition-all" style="width: ${progress}%"></div>
                </div>
                <div class="flex-1">
                    <div class="flex gap-2 mb-4">
                        <span class="bg-blue-50 text-blue-600 text-xs font-bold px-2 py-1 rounded">${q.type}</span>
                    </div>
                    <h2 class="text-xl font-bold mb-8 whitespace-pre-wrap leading-relaxed">${q.question}</h2>
                    <div class="space-y-3">
                        ${q.options.map((opt, i) => `
                            <button onclick="selectOption(${i})" class="w-full text-left p-5 rounded-2xl border-2 transition-all ${state.selectedOption === i ? 'border-blue-500 bg-blue-50 text-blue-600 font-bold' : 'border-gray-100 bg-white'}">
                                <span class="text-gray-400 mr-2">${i+1}.</span> ${opt}
                            </button>
                        `).join('')}
                    </div>
                </div>
                <button onclick="nextQuestion()" ${state.selectedOption === null ? 'disabled' : ''} class="btn-primary w-full py-4 rounded-xl font-bold text-lg mt-8">
                    ${state.currentIdx === state.questions.length - 1 ? '결과 보기' : '다음 문제'}
                </button>
            </div>
        `;
    };

    const renderResult = () => {
        const correctCount = state.userAnswers.filter((ans, i) => ans === state.questions[i].answer).length;
        const score = Math.round((correctCount / state.questions.length) * 100);

        return `
            <div class="w-full max-w-2xl p-6 pb-24">
                <div class="tos-card p-8 text-center mb-6">
                    <div class="text-5xl font-bold mb-2">${score}점</div>
                    <p class="text-gray-500">${score >= 50 ? '훌륭한 실력이에요!' : '조금만 더 힘내볼까요?'}</p>
                </div>
                <div class="space-y-4">
                    ${state.questions.map((q, i) => `
                        <div class="tos-card p-6">
                            <div class="flex justify-between mb-4">
                                <span class="text-xs font-bold text-gray-400">Q${i+1}</span>
                                <i data-lucide="${state.userAnswers[i] === q.answer ? 'check-circle-2' : 'x-circle'}" class="${state.userAnswers[i] === q.answer ? 'text-green-500' : 'text-red-500'}"></i>
                            </div>
                            <p class="font-bold mb-4">${q.question}</p>
                            <div class="bg-gray-50 p-4 rounded-xl text-sm leading-relaxed">
                                <p class="text-blue-600 font-bold mb-2">정답: ${q.options[q.answer]}</p>
                                <p class="text-gray-600">${q.explanation}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-md text-center">
                    <button onclick="location.reload()" class="btn-primary w-full max-w-2xl mx-auto block py-4 rounded-xl font-bold shadow-lg">처음으로</button>
                </div>
            </div>
        `;
    };

    window.selectOption = (i) => {
        state.selectedOption = i;
        render();
    };

    window.nextQuestion = () => {
        state.userAnswers.push(state.selectedOption);
        if (state.currentIdx < state.questions.length - 1) {
            state.currentIdx++;
            state.selectedOption = null;
            render();
        } else {
            state.step = 'result';
            render();
        }
    };

    window.onload = render;
</script>
</body>
</html>
